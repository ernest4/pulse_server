<button id="send_enter_button">Send Enter</button>
<br />
<br />
<button id="send_move_button_left">Send Move Left</button>
<button id="send_move_button_top">Send Move Top</button>
<button id="send_move_button_right">Send Move Right</button>
<button id="send_move_button_bottom">Send Move Bottom</button>
<br />
<br />
<div>
  <span>Maps: <%= game_state.maps.size %></span>
  <br />
  <% game_state.maps.each do |map_name, map| %>
    <br />
    <div>
      <span>name: <%= map_name %></span>
      <br />
      <span>tiles: <%= map.tiles.to_s %></span>
      <br />
      <span>clients: <%= map.clients.size %></span>
    </div>
  <% end %>
</div>

<script>
  let player_id = null;

  const MESSAGE_TYPE = {
    MOVE: 1,
    POSITION: 2,
    ENTER: 3,
    EXIT: 4,
  }

  const ws = new WebSocket(location.origin.replace('http', 'ws'));
  ws.binaryType = 'arraybuffer';
  ws.onmessage = msg => {
    console.log('msg');
    console.log(msg);

    console.log('msg.data');
    console.log(msg.data);

    console.log('message type');
    const view = new DataView(msg.data);
    const message_type = view.getUint8(0, true)
    console.log(message_type);

    switch(message_type) {
      case 0:
        // TODO:
        break;
      case MESSAGE_TYPE.POSITION:
        const x = view.getUint16(1, true);
        const y = view.getUint16(3, true);
        console.log('x');
        console.log(x);
        console.log('y');
        console.log(y);
        break;
      case MESSAGE_TYPE.ENTER:
        // TODO:

        // normal client will have its own id after log in and other players will be pushed into array...
        player_id = view.getInt32(1, true);

        console.log('decoder utf-8');

        const decoder = new TextDecoder("utf-8");
        const textSlice = msg.data.slice(6 , msg.data.length);
        console.log(decoder.decode(textSlice));
        break;
      case MESSAGE_TYPE.EXIT:
        console.log('exit');
        break;
      default:
        console.log('Unrecognised message type received');
    }
  };

  const sendEnterTest = () => {
    const encoder = new TextEncoder("utf-8");
    const encoded = encoder.encode("Γεια σουκόσμ");

    const buffer = new ArrayBuffer(1 + encoded.length);
    const view = new DataView(buffer);

    encoded.forEach((byte, index) => view.setUint8(index + 1, byte));

    view.setUint8(0, MESSAGE_TYPE.ENTER, true);
    // view.setUint16(2, 500, true);
    console.log('buffer');
    console.log(buffer);

    ws.send(buffer);
  };

  const sendEnterButton = document.getElementById('send_enter_button');
  sendEnterButton.addEventListener('click', sendEnterTest);

  const sendMove = ({directionalKey1, directionalKey2}) => {
    view.setUint8(0, MESSAGE_TYPE.MOVE, true);
    view.setUint8(1, directionalKey1, true);
    view.setUint8(2, directionalKey2, true);

    console.log('move buffer');
    console.log(buffer);

    ws.send(buffer);
  };

  const keyDownHandler = (event) => {
      if(event.keyCode == 39) {
        rightPressed = true;
    }
    else if(event.keyCode == 37) {
        leftPressed = true;
    }
    if(event.keyCode == 40) {
    	downPressed = true;
    }
    else if(event.keyCode == 38) {
    	upPressed = true;
    }
    switch(event.keyCode){
      case 37: // left
        sendMove({directionalKey1: 1});
        break;
      case 38: // up
        sendMove({directionalKey1: 2});
        break;
      case 39: // right
        sendMove({directionalKey1: 3});
        break;
      case 40: // down
        sendMove({directionalKey1: 4});
        break;
      default:
        console.log('unrecognised key command');
    }
  }

  document.addEventListener('keydown', keyDownHandler, false);
</script>